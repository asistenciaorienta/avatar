60<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <title>Live2D funcionando</title>
  <style>
    body { margin: 0; overflow: hidden; }
    canvas { position: fixed; top: 0; left: 0; width: 100%; height: 100%; }
  </style>
</head>
<body>

  <script>   //muestra ventana con la versión.
    window.onload = function() {
      alert("Versión 1.65");
    };
  </script>

  <!-- PIXI.js -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/pixi.js/5.3.12/pixi.min.js"></script>
  <!-- Live2D Cubism Core -->
  <script src="libs/Core/live2dcubismcore.min.js"></script>
  <!-- pixi-live2d-display con soporte Cubism 4 -->
  <script src="https://cdn.jsdelivr.net/npm/pixi-live2d-display@0.4.0/dist/cubism4.min.js"></script>

  <script> 
    const app = new PIXI.Application({
      view: document.createElement("canvas"),
      autoStart: true,
      resizeTo: window,
      //width: 800,
      //height: 600,      
      backgroundAlpha: 0,
      backgroundColor: 0xffffff // blanco, por ejemplo
    });
    document.body.appendChild(app.view);

    // Ruta de modelo y animación
    const modelPath = "modelo010925_2/modelo010925_2.model3.json";

    //variables para simular que parpadea
    let nextBlink = Date.now() + (2000 + Math.random() * 3000);
    let blinking = false;
    // control para pasos del parpadeo (0 -> 0.5 -> 1 -> 0)
    let blinkStep = 0; // 0 = esperando, 1 = 0.5, 2 = 1, 3 = volver a 0

    // 🔹 Variables para simular el habla
    let talking = false;
    let mouthValue = -1;
    let mouthSpeed = 0.08; // velocidad base apertura/cierre
    let nextMouthChange = Date.now() + 500; // momento del próximo cambio de velocidad
    // Cejas (parámetros que dijiste que tenías)
    const leftParam  = "ParametroCejaIzquierda";   // ojo/ceja izquierda (tú lo creaste)
    const rightParam = "ParametroCejaDerecha";     // ojo/ceja derecha
    // Variables de suavizado de cejas
    let browCurrentL = 0;
    let browCurrentR = 0;
    let browTargetL = 0;
    let browTargetR = 0;
    let nextBrowChange = Date.now() + 200; // cuándo recalcular un nuevo objetivo
    const browLerp = 0.12; // cuánto interpolar cada frame (0..1)
    
    // Helper: lerp
    function lerp(a, b, t) { return a + (b - a) * t; }
    
    // ------------------------------------Cargar modelo-------------------------------------
    PIXI.live2d.Live2DModel.from(modelPath).then(model => {
      model.scale.set(0.25);
      model.x = (window.innerWidth - model.width * model.scale.x) / 2;
      model.y = (window.innerHeight - model.height * model.scale.y) / 2;
      app.stage.addChild(model);

// Detener animaciones automáticas--------------------------------------------------------------Nuevo
      model.motionManager?.stopAllMotions();
      //model.internalModel.motionManager.stopAllMotions();
      model.internalModel.expressionManager?.stopAllExpressions();


      
      //estado inicial
      model.internalModel.coreModel.setParameterValueById("ParametroParpadeo", 0); //inicio con ojos abiertos
      model.internalModel.coreModel.setParameterValueById("ParametroAtencion", -30.0); //inicio con ojos y cejas normales
      model.internalModel.coreModel.setParameterValueById("Parametromoverpierna", -30.0); //inicio con pierna natural
      model.internalModel.coreModel.setParameterValueById("ParametroMouthOpen", 0.0); //inicio con boca cerrada
      model.internalModel.coreModel.setParameterValueById("ParametroMouthSpeak", -1.0); //inicio no habla
      
      // 👉 Evento: hacer clic para que empiece/parar de hablar
      model.interactive = true;
      model.buttonMode = true;
      model.on("pointerdown", () => {
        talking = !talking; // alterna hablar/no hablar      
      });   
      // 👀 Forzar parámetros en cada frame
      app.ticker.add(() => {
        //-------------------------------------Parpadeo------------------------------------
        const now = Date.now();      
        if (!blinking && now >= nextBlink) {
          // Inicia parpadeo
          blinking = true;
          blinkStep = 1;
          nextBlink = now + 50; // cerrar ojos durante 0.1s (antes 100)
          model.internalModel.coreModel.setParameterValueById("ParametroParpadeo", 0.5); //antes 1
        } else if (blinking && now >= nextBlink) {
          if (blinkStep === 1) {
            // paso 2: completamente cerrado
            blinkStep = 2;
            nextBlink = now + 50;
            model.internalModel.coreModel.setParameterValueById("ParametroParpadeo", 1);
          } else if (blinkStep === 2) {
            // paso 3: abrir
            blinkStep = 3;
            nextBlink = now + 50;
            model.internalModel.coreModel.setParameterValueById("ParametroParpadeo", 0);
          } else {
            // fin parpadeo
            blinking = false;
            blinkStep = 0;
            nextBlink = now + (2000 + Math.random() * 3000);
          }    
        }      

        //------------------------------Hablar---------------------------------
        if (talking) {
          model.internalModel.coreModel.setParameterValueById("ParametroMouthOpen", 1.0); //boca abierta

          if (now >= nextMouthChange) {
            mouthSpeed = (Math.random() * 0.15) + 0.05;
            if (Math.random() < 0.5) mouthSpeed *= -1;
            nextMouthChange = now + (200 + Math.random() * 700); // 0.25..0.95s //antes 400
          }
          //animar la boca
          mouthValue += mouthSpeed;
          if (mouthValue > 1) { mouthValue = 1; mouthSpeed *= -1; }
          if (mouthValue < -1) { mouthValue = -1; mouthSpeed *= -1; }
          model.internalModel.coreModel.setParameterValueById("ParametroMouthSpeak", mouthValue);
          // preparar nuevo objetivo de cejas cada X ms
          if (now >= nextBrowChange) {
            browTargetL = (Math.random() * 60) - 30; // -30 .. 30
            browTargetR = (Math.random() * 60) - 30;
            nextBrowChange = now + (200 + Math.random() * 400); // 0.2..0.6s
          }
        } else {
          // no hablar -> cerrar boca y reset cejas target a 0
          model.internalModel.coreModel.setParameterValueById("ParametroMouthSpeak", -1.0);
          model.internalModel.coreModel.setParameterValueById("ParametroMouthOpen", 0.0);
          browTargetL = 0;
          browTargetR = 0;
        }
        // ---------- SUAVIZAR CEJAS (siempre se aplica) ----------
        // interpolamos desde current hacia target
        browCurrentL = lerp(browCurrentL, browTargetL, browLerp);
        browCurrentR = lerp(browCurrentR, browTargetR, browLerp);

        // aplicar valores a parámetros (asegúrate de usar los IDs correctos)
        model.internalModel.coreModel.setParameterValueById(leftParam, browCurrentL);
        model.internalModel.coreModel.setParameterValueById(rightParam, browCurrentR);    
        
      //console.log(model); 
      });
    }).catch(err => console.error("Error cargando modelo:", err));
  </script>
</body>
</html>












